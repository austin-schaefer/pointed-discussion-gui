<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ card_name }} - All Printings - Pointed Discussion</title>
    <link rel="stylesheet" href="../../static/style.css">
</head>
<body>
    <header>
        <h1><a href="../../index.html">Pointed Discussion</a></h1>
        <p>Magic: The Gathering Card Comments Archive</p>
    </header>

    <main>
        <div class="combined-container">
            <div class="combined-header">
                <h2>{{ card_name }} - All Printings</h2>
                <p class="combined-subtitle">
                    Showing {{ total_comments }} comments across {{ printings|length }} printing{{ 's' if printings|length != 1 else '' }}
                </p>
            </div>

            <div class="printings-selector">
                <label for="printing-filter">Filter by printing:</label>
                <select id="printing-filter">
                    <option value="all">All Printings ({{ total_comments }} comments)</option>
                    {% for printing in printings %}
                    <option value="{{ printing.multiverse_id }}">
                        {{ printing.set_name or 'Unknown Set' }} [{{ printing.set_code or '?' }}]
                        ({{ printing.comments|length }} comments)
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="comments-section">
                <div class="comments-header">
                    <h3 id="comment-count-display">All Comments ({{ total_comments }})</h3>
                    <div class="comment-sort-controls">
                        <label for="comment-sort">Sort by:</label>
                        <select id="comment-sort">
                            <option value="rating">Highest Rated</option>
                            <option value="date">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="printing">By Printing (Release Order)</option>
                        </select>
                    </div>
                </div>

                <div class="comments-list" id="comments-list">
                    {% for printing in printings %}
                        {% for comment in printing.comments %}
                        <article class="comment"
                                 data-comment-id="{{ comment.id }}"
                                 data-rating="{{ comment.star_rating }}"
                                 data-vote-count="{{ comment.vote_count }}"
                                 data-date="{{ comment.datetime }}"
                                 data-timestamp="{{ comment.timestamp }}"
                                 data-printing-id="{{ printing.multiverse_id }}"
                                 data-printing-date="{{ printing.released_at or '9999-99-99' }}">
                            <header class="comment-header">
                                <strong class="comment-author">{{ comment.author }}</strong>
                                <time class="comment-date" datetime="{{ comment.datetime }}" title="{{ comment.datetime }}">
                                    {{ comment.datetime.split(' ')[0] }}
                                </time>
                                <div class="comment-rating">
                                    <span class="stars">{{ comment.star_display }}</span>
                                    {% if comment.vote_count > 0 %}
                                    <span class="vote-info">({{ comment.vote_count }} vote{{ 's' if comment.vote_count != 1 else '' }})</span>
                                    {% endif %}
                                </div>
                                <div class="printing-badge">
                                    <a href="../{{ printing.multiverse_id }}.html" title="View this printing">
                                        {{ printing.set_code or '?' }}
                                        {% if printing.collector_number %}#{{ printing.collector_number }}{% endif %}
                                    </a>
                                </div>
                            </header>
                            <div class="comment-content">
                                {{ comment.text_parsed|safe }}
                            </div>
                        </article>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>Generated from Gatherer Comment Section Archive</p>
        <div class="footer-links">
            <a href="../../index.html">‚Üê Back to Search</a>
            <span class="footer-separator">|</span>
            <a href="https://github.com/austin-schaefer/pointed-discussion-gui" target="_blank" rel="noopener" class="github-link">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
                View Repo
            </a>
            <span class="footer-separator">|</span>
            <a href="https://github.com/maxmakesmagic/pointed-discussion" target="_blank" rel="noopener" class="github-link">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
                Forked From
            </a>
        </div>
    </footer>

    <script>
        class CombinedCommentManager {
            constructor() {
                this.commentsContainer = document.getElementById('comments-list');
                this.sortSelect = document.getElementById('comment-sort');
                this.filterSelect = document.getElementById('printing-filter');
                this.countDisplay = document.getElementById('comment-count-display');
                this.comments = [];
                this.currentFilter = 'all';

                if (this.commentsContainer && this.sortSelect && this.filterSelect) {
                    this.extractComments();
                    this.initializeControls();
                    // Set default sorting to by printing (release order)
                    this.sortSelect.value = 'printing';
                    this.sortComments('printing');
                }
            }

            extractComments() {
                const commentElements = this.commentsContainer.querySelectorAll('.comment');
                this.comments = Array.from(commentElements).map(element => ({
                    element: element,
                    id: element.dataset.commentId,
                    rating: parseFloat(element.dataset.rating) || 0,
                    voteCount: parseInt(element.dataset.voteCount) || 0,
                    date: element.dataset.date,
                    timestamp: parseInt(element.dataset.timestamp) || 0,
                    printingId: element.dataset.printingId,
                    printingDate: element.dataset.printingDate
                }));
            }

            initializeControls() {
                this.sortSelect.addEventListener('change', (e) => {
                    this.sortComments(e.target.value);
                });

                this.filterSelect.addEventListener('change', (e) => {
                    this.currentFilter = e.target.value;
                    this.applyFilter();
                });
            }

            applyFilter() {
                let visibleCount = 0;

                this.comments.forEach(comment => {
                    if (this.currentFilter === 'all' || comment.printingId === this.currentFilter) {
                        comment.element.style.display = '';
                        visibleCount++;
                    } else {
                        comment.element.style.display = 'none';
                    }
                });

                // Update count display
                if (this.currentFilter === 'all') {
                    this.countDisplay.textContent = `All Comments (${visibleCount})`;
                } else {
                    const selectedOption = this.filterSelect.options[this.filterSelect.selectedIndex];
                    this.countDisplay.textContent = `Filtered Comments (${visibleCount})`;
                }
            }

            sortComments(sortBy) {
                let sortedComments;

                switch (sortBy) {
                    case 'rating':
                        sortedComments = this.comments.sort((a, b) => {
                            if (b.rating !== a.rating) return b.rating - a.rating;
                            if (b.voteCount !== a.voteCount) return b.voteCount - a.voteCount;
                            return b.timestamp - a.timestamp;
                        });
                        break;

                    case 'date':
                        sortedComments = this.comments.sort((a, b) => b.timestamp - a.timestamp);
                        break;

                    case 'date-asc':
                        sortedComments = this.comments.sort((a, b) => a.timestamp - b.timestamp);
                        break;

                    case 'printing':
                        sortedComments = this.comments.sort((a, b) => {
                            if (a.printingDate !== b.printingDate) {
                                return a.printingDate.localeCompare(b.printingDate);
                            }
                            return b.timestamp - a.timestamp;
                        });
                        break;

                    default:
                        sortedComments = this.comments;
                }

                sortedComments.forEach(comment => {
                    this.commentsContainer.appendChild(comment.element);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new CombinedCommentManager();
        });
    </script>

    <style>
        .combined-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .combined-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #3498db;
        }

        .combined-header h2 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .combined-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .printings-selector {
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-left: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .printings-selector label {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
        }

        .printings-selector select {
            flex: 1;
            padding: 0.35rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .printings-selector select:focus {
            outline: none;
            border-color: #3498db;
        }

        .printing-badge {
            background: #3498db;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .printing-badge a {
            color: white;
            text-decoration: none;
        }

        .printing-badge a:hover {
            text-decoration: underline;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .comment-sort-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comment-sort-controls label {
            font-size: 0.9rem;
            color: #666;
        }

        .comment-sort-controls select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            font-size: 0.85rem;
        }

        .comment-sort-controls select:focus {
            outline: none;
            border-color: #3498db;
        }

        @media (max-width: 768px) {
            .combined-container {
                padding: 0.75rem;
            }

            .combined-header h2 {
                font-size: 1.3rem;
            }

            .printings-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .printings-selector label {
                margin-bottom: 0.25rem;
            }


            .comments-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .combined-container {
                padding: 0.5rem;
            }

            .combined-header {
                padding-bottom: 0.5rem;
            }

            .combined-header h2 {
                font-size: 1.2rem;
            }

            .combined-subtitle {
                font-size: 0.85rem;
            }
        }
    </style>
</body>
</html>
